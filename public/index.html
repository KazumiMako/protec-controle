<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Protec Contrôle - VGP</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #1a56db; --primary-dark: #1e40af; --primary-light: #dbeafe;
      --danger: #dc2626; --success: #16a34a; --warning: #f59e0b; --info: #0891b2;
      --bg: #f1f5f9; --white: #ffffff; --text: #1e293b; --text-light: #64748b;
      --border: #e2e8f0; --shadow: 0 1px 3px rgba(0,0,0,.1); --radius: 8px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); }
    
    /* Layout */
    .app-layout { display: flex; min-height: 100vh; }
    .sidebar { width: 260px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; padding: 0; position: fixed; height: 100vh; overflow-y: auto; z-index: 100; transition: transform .3s; }
    .sidebar.closed { transform: translateX(-260px); }
    .sidebar-logo { padding: 24px 20px; border-bottom: 1px solid rgba(255,255,255,.1); display: flex; align-items: center; gap: 12px; }
    .sidebar-logo h1 { font-size: 18px; font-weight: 700; }
    .sidebar-logo .icon { width: 40px; height: 40px; background: var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .sidebar-nav { padding: 16px 12px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--radius); cursor: pointer; transition: all .2s; color: rgba(255,255,255,.7); font-size: 14px; margin-bottom: 4px; text-decoration: none; }
    .nav-item:hover, .nav-item.active { background: rgba(255,255,255,.1); color: white; }
    .nav-item i { width: 20px; text-align: center; }
    .nav-section { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: rgba(255,255,255,.4); padding: 16px 16px 8px; }
    
    .main-content { flex: 1; margin-left: 260px; transition: margin-left .3s; }
    .main-content.full { margin-left: 0; }
    .topbar { background: white; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; }
    .topbar h2 { font-size: 20px; font-weight: 600; }
    .page-content { padding: 24px; max-width: 1400px; margin: 0 auto; }
    
    /* Cards & Tiles */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px; }
    .tile { background: white; border-radius: 12px; padding: 24px; box-shadow: var(--shadow); cursor: pointer; transition: all .2s; border-left: 4px solid transparent; }
    .tile:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.1); }
    .tile.warning { border-left-color: var(--warning); }
    .tile.info { border-left-color: var(--info); }
    .tile.primary { border-left-color: var(--primary); }
    .tile.success { border-left-color: var(--success); }
    .tile-count { font-size: 36px; font-weight: 700; margin-bottom: 4px; }
    .tile-label { color: var(--text-light); font-size: 14px; }
    .tile-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 16px; }
    .tile.warning .tile-icon { background: #fef3c7; color: var(--warning); }
    .tile.info .tile-icon { background: #cffafe; color: var(--info); }
    .tile.primary .tile-icon { background: var(--primary-light); color: var(--primary); }
    .tile.success .tile-icon { background: #dcfce7; color: var(--success); }
    
    /* Tables */
    .card { background: white; border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; }
    .card-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
    .card-header h3 { font-size: 16px; font-weight: 600; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px 16px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; color: var(--text-light); background: #f8fafc; border-bottom: 1px solid var(--border); }
    td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 14px; }
    tr:hover td { background: #f8fafc; }
    
    /* Buttons */
    .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; transition: all .2s; text-decoration: none; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { background: #f8fafc; }
    .btn-sm { padding: 6px 10px; font-size: 12px; }
    .btn-icon { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 6px; border: 1px solid var(--border); background: white; cursor: pointer; color: var(--text-light); }
    .btn-icon:hover { background: #f8fafc; color: var(--text); }
    .btn-group { display: flex; gap: 6px; }
    
    /* Forms */
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--text); }
    .form-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; transition: border-color .2s; }
    .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26,86,219,.1); }
    select.form-input { cursor: pointer; }
    textarea.form-input { resize: vertical; min-height: 80px; }
    
    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal { background: white; border-radius: 12px; width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-size: 16px; font-weight: 600; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }
    .modal-close { background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text-light); }
    
    /* Badges */
    .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-info { background: #cffafe; color: #155e75; }
    .badge-primary { background: var(--primary-light); color: var(--primary-dark); }
    .badge-success { background: #dcfce7; color: #166534; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    
    /* Search */
    .search-box { position: relative; }
    .search-box input { padding-left: 36px; }
    .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-light); font-size: 14px; }
    
    /* Pagination */
    .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; padding: 16px; }
    .pagination button { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: pointer; font-size: 13px; }
    .pagination button.active { background: var(--primary); color: white; border-color: var(--primary); }
    .pagination button:disabled { opacity: .4; cursor: not-allowed; }
    
    /* Login */
    .login-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 20px; }
    .login-card { background: white; border-radius: 16px; padding: 40px; width: 100%; max-width: 420px; box-shadow: 0 20px 60px rgba(0,0,0,.3); }
    .login-card h1 { text-align: center; margin-bottom: 8px; font-size: 24px; }
    .login-card p { text-align: center; color: var(--text-light); margin-bottom: 32px; font-size: 14px; }
    .login-icon { width: 64px; height: 64px; background: var(--primary); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 28px; color: white; }
    .error-msg { background: #fee2e2; color: #991b1b; padding: 10px 14px; border-radius: 6px; font-size: 13px; margin-bottom: 16px; }
    .success-msg { background: #dcfce7; color: #166534; padding: 10px 14px; border-radius: 6px; font-size: 13px; margin-bottom: 16px; }
    
    /* Form control */
    .control-form { display: grid; gap: 24px; }
    .control-section { background: white; border-radius: 12px; padding: 24px; box-shadow: var(--shadow); }
    .control-section h3 { font-size: 15px; font-weight: 600; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--primary-light); color: var(--primary-dark); }
    .control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
    .radio-group { display: flex; gap: 16px; flex-wrap: wrap; }
    .radio-option { display: flex; align-items: center; gap: 6px; cursor: pointer; }
    .radio-option input[type="radio"] { accent-color: var(--primary); }
    
    /* Responsive */
    .menu-toggle { display: none; background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text); }
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-260px); }
      .sidebar.open { transform: translateX(0); }
      .main-content { margin-left: 0 !important; }
      .menu-toggle { display: block; }
      .dashboard-grid { grid-template-columns: 1fr 1fr; }
      .topbar { padding: 12px 16px; }
      .page-content { padding: 16px; }
      table { font-size: 13px; }
      th, td { padding: 10px 8px; }
    }
    @media (max-width: 480px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }
    
    /* Signature */
    .signature-pad { border: 2px dashed var(--border); border-radius: 8px; cursor: crosshair; touch-action: none; }
    
    /* Spinner */
    .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin .6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Empty state */
    .empty-state { text-align: center; padding: 48px 24px; color: var(--text-light); }
    .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: .3; }
    .empty-state p { font-size: 14px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, createContext, useContext } = React;

    // ============================================================
    // API Helper
    // ============================================================
    const API_BASE = '';
    const api = {
      token: localStorage.getItem('protec_token'),
      setToken(t) { this.token = t; if(t) localStorage.setItem('protec_token',t); else localStorage.removeItem('protec_token'); },
      async req(method, url, body) {
        const opts = { method, headers: { 'Content-Type': 'application/json' } };
        if (this.token) opts.headers.Authorization = `Bearer ${this.token}`;
        if (body) opts.body = JSON.stringify(body);
        const res = await fetch(API_BASE + url, opts);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Erreur');
        return data;
      },
      get: (u) => api.req('GET', u),
      post: (u, b) => api.req('POST', u, b),
      put: (u, b) => api.req('PUT', u, b),
      del: (u) => api.req('DELETE', u),
    };

    // ============================================================
    // Auth Context
    // ============================================================
    const AuthContext = createContext(null);
    function AuthProvider({ children }) {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        if (api.token) {
          api.get('/api/profile').then(setUser).catch(() => { api.setToken(null); }).finally(() => setLoading(false));
        } else setLoading(false);
      }, []);

      const login = async (email, password) => {
        const data = await api.post('/api/auth/login', { email, password });
        api.setToken(data.token);
        setUser(data.user);
      };
      const logout = () => { api.setToken(null); setUser(null); };
      
      if (loading) return React.createElement('div', { style: { display:'flex', alignItems:'center', justifyContent:'center', height:'100vh' } },
        React.createElement('div', { className: 'spinner', style: { width:40, height:40 } })
      );
      return React.createElement(AuthContext.Provider, { value: { user, setUser, login, logout } }, children);
    }

    // ============================================================
    // Modal Component
    // ============================================================
    function Modal({ open, onClose, title, children, footer }) {
      if (!open) return null;
      return React.createElement('div', { className: 'modal-overlay', onClick: (e) => e.target === e.currentTarget && onClose() },
        React.createElement('div', { className: 'modal' },
          React.createElement('div', { className: 'modal-header' },
            React.createElement('h3', null, title),
            React.createElement('button', { className: 'modal-close', onClick: onClose }, React.createElement('i', { className: 'fas fa-times' }))
          ),
          React.createElement('div', { className: 'modal-body' }, children),
          footer && React.createElement('div', { className: 'modal-footer' }, footer)
        )
      );
    }

    // ============================================================
    // Confirm Dialog
    // ============================================================
    function useConfirm() {
      const [state, setState] = useState({ open: false, msg: '', resolve: null });
      const confirm = (msg) => new Promise(r => setState({ open: true, msg, resolve: r }));
      const dialog = state.open ? React.createElement(Modal, {
        open: true, title: 'Confirmation',
        onClose: () => { state.resolve(false); setState({ open: false }); },
        footer: React.createElement(React.Fragment, null,
          React.createElement('button', { className: 'btn btn-outline', onClick: () => { state.resolve(false); setState({ open: false }); } }, 'Annuler'),
          React.createElement('button', { className: 'btn btn-danger', onClick: () => { state.resolve(true); setState({ open: false }); } }, 'Confirmer')
        )
      }, React.createElement('p', null, state.msg)) : null;
      return [confirm, dialog];
    }

    // ============================================================
    // Status helpers
    // ============================================================
    const STATUS_MAP = {
      a_planifier: { label: 'À planifier', badge: 'badge-warning', icon: 'fa-clock' },
      a_faire: { label: 'À faire', badge: 'badge-info', icon: 'fa-calendar-check' },
      en_cours: { label: 'En cours', badge: 'badge-primary', icon: 'fa-spinner' },
      termine: { label: 'Terminé', badge: 'badge-success', icon: 'fa-check-circle' },
    };
    function StatusBadge({ status }) {
      const s = STATUS_MAP[status] || {};
      return React.createElement('span', { className: `badge ${s.badge}` },
        React.createElement('i', { className: `fas ${s.icon}`, style: { marginRight: 6 } }), s.label
      );
    }

    // ============================================================
    // Login Page
    // ============================================================
    function LoginPage() {
      const { login } = useContext(AuthContext);
      const [email, setEmail] = useState('test@protec.com');
      const [password, setPassword] = useState('Test@2024!');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [forgotMode, setForgotMode] = useState(false);
      const [success, setSuccess] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault(); setError(''); setLoading(true);
        try {
          if (forgotMode) {
            const r = await api.post('/api/auth/forgot-password', { email });
            setSuccess(r.message);
            setForgotMode(false);
          } else {
            await login(email, password);
          }
        } catch(err) { setError(err.message); }
        setLoading(false);
      };

      return React.createElement('div', { className: 'login-page' },
        React.createElement('div', { className: 'login-card' },
          React.createElement('div', { className: 'login-icon' }, React.createElement('i', { className: 'fas fa-shield-alt' })),
          React.createElement('h1', null, 'Protec Contrôle'),
          React.createElement('p', null, forgotMode ? 'Réinitialisation du mot de passe' : 'Gestion des Vérifications Générales Périodiques'),
          error && React.createElement('div', { className: 'error-msg' }, error),
          success && React.createElement('div', { className: 'success-msg' }, success),
          React.createElement('form', { onSubmit: handleSubmit },
            React.createElement('div', { className: 'form-group' },
              React.createElement('label', null, 'Email'),
              React.createElement('input', { className: 'form-input', type: 'email', value: email, onChange: e => setEmail(e.target.value), required: true })
            ),
            !forgotMode && React.createElement('div', { className: 'form-group' },
              React.createElement('label', null, 'Mot de passe'),
              React.createElement('input', { className: 'form-input', type: 'password', value: password, onChange: e => setPassword(e.target.value), required: true })
            ),
            React.createElement('button', { className: 'btn btn-primary', type: 'submit', disabled: loading, style: { width: '100%', padding: '12px', fontSize: '15px', marginTop: 8 } },
              loading ? React.createElement('div', { className: 'spinner' }) : (forgotMode ? 'Envoyer le lien' : 'Se connecter')
            ),
            React.createElement('div', { style: { textAlign: 'center', marginTop: 16 } },
              React.createElement('a', { href: '#', onClick: (e) => { e.preventDefault(); setForgotMode(!forgotMode); setError(''); setSuccess(''); }, style: { color: 'var(--primary)', fontSize: 13, textDecoration: 'none' } },
                forgotMode ? 'Retour à la connexion' : 'Mot de passe oublié ?'
              )
            )
          )
        )
      );
    }

    // ============================================================
    // Dashboard
    // ============================================================
    function Dashboard({ onNavigate }) {
      const [counts, setCounts] = useState({ a_planifier: 0, a_faire: 0, en_cours: 0, termine: 0 });
      useEffect(() => { api.get('/api/dashboard').then(setCounts).catch(console.error); }, []);

      const tiles = [
        { key: 'a_planifier', label: 'À planifier', icon: 'fa-clock', cls: 'warning' },
        { key: 'a_faire', label: 'À faire', icon: 'fa-calendar-check', cls: 'info' },
        { key: 'en_cours', label: 'En cours', icon: 'fa-spinner', cls: 'primary' },
        { key: 'termine', label: 'Terminés', icon: 'fa-check-circle', cls: 'success' },
      ];

      return React.createElement('div', null,
        React.createElement('div', { className: 'dashboard-grid' },
          tiles.map(t => React.createElement('div', { key: t.key, className: `tile ${t.cls}`, onClick: () => onNavigate('controles', { status: t.key }) },
            React.createElement('div', { className: 'tile-icon' }, React.createElement('i', { className: `fas ${t.icon}` })),
            React.createElement('div', { className: 'tile-count' }, counts[t.key]),
            React.createElement('div', { className: 'tile-label' }, `Contrôles ${t.label.toLowerCase()}`)
          ))
        )
      );
    }

    // ============================================================
    // Controles List
    // ============================================================
    function ControlesList({ status, onNavigate }) {
      const [data, setData] = useState({ controles: [], total: 0, page: 1, totalPages: 1 });
      const [loading, setLoading] = useState(true);
      const [planModal, setPlanModal] = useState(null);
      const [planDate, setPlanDate] = useState('');
      const [confirm, confirmDialog] = useConfirm();

      const load = (page = 1) => {
        setLoading(true);
        api.get(`/api/controles?status=${status}&page=${page}&limit=10`).then(setData).catch(console.error).finally(() => setLoading(false));
      };
      useEffect(() => { load(); }, [status]);

      const handlePlan = async () => {
        if (!planDate) return;
        await api.put(`/api/controles/${planModal}`, { plannedDate: planDate, status: 'a_faire' });
        setPlanModal(null); setPlanDate(''); load();
      };

      const handleDelete = async (id) => {
        if (await confirm('Supprimer ce contrôle ?')) {
          await api.del(`/api/controles/${id}`); load();
        }
      };

      const handleChangePlanDate = async (id) => {
        setPlanModal(id);
        const c = data.controles.find(x => x.id === id);
        setPlanDate(c?.plannedDate || '');
      };

      const statusInfo = STATUS_MAP[status] || {};

      return React.createElement('div', null,
        React.createElement('div', { className: 'card' },
          React.createElement('div', { className: 'card-header' },
            React.createElement('h3', null, `Contrôles ${statusInfo.label || ''}`),
            React.createElement('span', { className: 'badge ' + statusInfo.badge }, data.total, ' résultat(s)')
          ),
          loading ? React.createElement('div', { style: { padding: 40, textAlign: 'center' } }, React.createElement('div', { className: 'spinner' })) :
          data.controles.length === 0 ? React.createElement('div', { className: 'empty-state' }, React.createElement('i', { className: 'fas fa-clipboard-list' }), React.createElement('p', null, 'Aucun contrôle')) :
          React.createElement('div', { style: { overflowX: 'auto' } },
            React.createElement('table', null,
              React.createElement('thead', null,
                React.createElement('tr', null,
                  React.createElement('th', null, 'Machine'),
                  React.createElement('th', null, 'Type'),
                  React.createElement('th', null, 'Client'),
                  status === 'a_planifier' && React.createElement('th', null, 'Expiration'),
                  status === 'a_planifier' && React.createElement('th', null, 'Dernier contrôle'),
                  status === 'a_faire' && React.createElement('th', null, 'Date planifiée'),
                  (status === 'en_cours' || status === 'termine') && React.createElement('th', null, 'Date contrôle'),
                  React.createElement('th', null, 'Actions')
                )
              ),
              React.createElement('tbody', null,
                data.controles.map(c => React.createElement('tr', { key: c.id },
                  React.createElement('td', null, React.createElement('strong', null, c.machineName)),
                  React.createElement('td', null, c.machineType),
                  React.createElement('td', null, c.clientName),
                  status === 'a_planifier' && React.createElement('td', null, React.createElement('span', { className: 'badge badge-warning' }, c.expirationDate || '-')),
                  status === 'a_planifier' && React.createElement('td', null, c.controlDate || '-'),
                  status === 'a_faire' && React.createElement('td', null, c.plannedDate || '-'),
                  (status === 'en_cours' || status === 'termine') && React.createElement('td', null, c.controlDate || '-'),
                  React.createElement('td', null,
                    React.createElement('div', { className: 'btn-group' },
                      status === 'a_planifier' && React.createElement('button', { className: 'btn btn-sm btn-primary', onClick: () => handleChangePlanDate(c.id), title: 'Planifier' },
                        React.createElement('i', { className: 'fas fa-calendar-plus' }), ' Planifier'
                      ),
                      status === 'a_faire' && React.createElement('button', { className: 'btn btn-sm btn-outline', onClick: () => handleChangePlanDate(c.id), title: 'Modifier date' },
                        React.createElement('i', { className: 'fas fa-calendar-alt' })
                      ),
                      status === 'a_faire' && React.createElement('button', { className: 'btn btn-sm btn-primary', onClick: () => onNavigate('controle-form', { id: c.id }), title: 'Effectuer' },
                        React.createElement('i', { className: 'fas fa-clipboard-check' }), ' Effectuer'
                      ),
                      status === 'en_cours' && React.createElement('button', { className: 'btn btn-sm btn-primary', onClick: () => onNavigate('controle-form', { id: c.id }), title: 'Reprendre' },
                        React.createElement('i', { className: 'fas fa-edit' }), ' Reprendre'
                      ),
                      status === 'termine' && React.createElement('button', { className: 'btn btn-sm btn-success', onClick: () => onNavigate('controle-view', { id: c.id }), title: 'Voir rapport' },
                        React.createElement('i', { className: 'fas fa-file-pdf' }), ' Rapport'
                      ),
                      React.createElement('button', { className: 'btn-icon', onClick: () => handleDelete(c.id), title: 'Supprimer' },
                        React.createElement('i', { className: 'fas fa-trash', style: { color: 'var(--danger)' } })
                      )
                    )
                  )
                ))
              )
            )
          ),
          data.totalPages > 1 && React.createElement('div', { className: 'pagination' },
            React.createElement('button', { onClick: () => load(data.page - 1), disabled: data.page <= 1 }, React.createElement('i', { className: 'fas fa-chevron-left' })),
            Array.from({ length: data.totalPages }, (_, i) =>
              React.createElement('button', { key: i, className: data.page === i + 1 ? 'active' : '', onClick: () => load(i + 1) }, i + 1)
            ),
            React.createElement('button', { onClick: () => load(data.page + 1), disabled: data.page >= data.totalPages }, React.createElement('i', { className: 'fas fa-chevron-right' }))
          )
        ),
        // Plan modal
        React.createElement(Modal, {
          open: !!planModal, onClose: () => setPlanModal(null), title: 'Planifier le contrôle',
          footer: React.createElement(React.Fragment, null,
            React.createElement('button', { className: 'btn btn-outline', onClick: () => setPlanModal(null) }, 'Annuler'),
            React.createElement('button', { className: 'btn btn-primary', onClick: handlePlan }, 'Valider')
          )
        },
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', null, 'Date du contrôle'),
            React.createElement('input', { type: 'date', className: 'form-input', value: planDate, onChange: e => setPlanDate(e.target.value) })
          )
        ),
        confirmDialog
      );
    }

    // ============================================================
    // Clients List
    // ============================================================
    function ClientsList({ onNavigate }) {
      const [clients, setClients] = useState([]);
      const [search, setSearch] = useState('');
      const [modal, setModal] = useState(null); // null | 'add' | client object
      const [form, setForm] = useState({ firstName: '', lastName: '', companyName: '', address: '', phone: '', sector: '' });
      const [confirm, confirmDialog] = useConfirm();

      const load = () => api.get(`/api/clients?search=${search}`).then(setClients).catch(console.error);
      useEffect(() => { load(); }, [search]);

      const openAdd = () => { setForm({ firstName: '', lastName: '', companyName: '', address: '', phone: '', sector: '' }); setModal('add'); };
      const openEdit = (c) => { setForm({ ...c }); setModal(c); };

      const handleSave = async () => {
        if (!form.firstName || !form.lastName || !form.companyName) return;
        if (modal === 'add') await api.post('/api/clients', form);
        else await api.put(`/api/clients/${modal.id}`, form);
        setModal(null); load();
      };

      const handleDelete = async (id) => {
        if (await confirm('Supprimer ce client et toutes ses machines ?')) {
          await api.del(`/api/clients/${id}`); load();
        }
      };

      return React.createElement('div', null,
        React.createElement('div', { className: 'card' },
          React.createElement('div', { className: 'card-header' },
            React.createElement('div', { className: 'search-box' },
              React.createElement('i', { className: 'fas fa-search' }),
              React.createElement('input', { className: 'form-input', placeholder: 'Rechercher par entreprise...', value: search, onChange: e => setSearch(e.target.value), style: { width: 280 } })
            ),
            React.createElement('button', { className: 'btn btn-primary', onClick: openAdd },
              React.createElement('i', { className: 'fas fa-plus' }), ' Ajouter un client'
            )
          ),
          clients.length === 0 ? React.createElement('div', { className: 'empty-state' }, React.createElement('i', { className: 'fas fa-users' }), React.createElement('p', null, 'Aucun client')) :
          React.createElement('div', { style: { overflowX: 'auto' } },
            React.createElement('table', null,
              React.createElement('thead', null,
                React.createElement('tr', null,
                  React.createElement('th', null, 'Entreprise'),
                  React.createElement('th', null, 'Contact'),
                  React.createElement('th', null, 'Téléphone'),
                  React.createElement('th', null, 'Secteur'),
                  React.createElement('th', null, 'Actions')
                )
              ),
              React.createElement('tbody', null,
                clients.map(c => React.createElement('tr', { key: c.id },
                  React.createElement('td', null, React.createElement('strong', null, c.companyName)),
                  React.createElement('td', null, `${c.firstName} ${c.lastName}`),
                  React.createElement('td', null, c.phone || '-'),
                  React.createElement('td', null, c.sector ? React.createElement('span', { className: 'badge badge-info' }, c.sector) : '-'),
                  React.createElement('td', null,
                    React.createElement('div', { className: 'btn-group' },
                      React.createElement('button', { className: 'btn btn-sm btn-outline', onClick: () => openEdit(c) },
                        React.createElement('i', { className: 'fas fa-edit' })
                      ),
                      React.createElement('button', { className: 'btn btn-sm btn-primary', onClick: () => onNavigate('machines', { clientId: c.id, clientName: c.companyName }) },
                        React.createElement('i', { className: 'fas fa-cogs' }), ' Machines'
                      ),
                      React.createElement('button', { className: 'btn-icon', onClick: () => handleDelete(c.id) },
                        React.createElement('i', { className: 'fas fa-trash', style: { color: 'var(--danger)' } })
                      )
                    )
                  )
                ))
              )
            )
          )
        ),
        // Client form modal
        React.createElement(Modal, {
          open: !!modal, onClose: () => setModal(null), title: modal === 'add' ? 'Nouveau client' : 'Modifier le client',
          footer: React.createElement(React.Fragment, null,
            React.createElement('button', { className: 'btn btn-outline', onClick: () => setModal(null) }, 'Annuler'),
            React.createElement('button', { className: 'btn btn-primary', onClick: handleSave }, 'Enregistrer')
          )
        },
          ['firstName:Prénom', 'lastName:Nom', 'companyName:Entreprise', 'address:Adresse', 'phone:Téléphone', 'sector:Secteur'].map(f => {
            const [key, label] = f.split(':');
            return React.createElement('div', { key, className: 'form-group' },
              React.createElement('label', null, label),
              React.createElement('input', { className: 'form-input', value: form[key] || '', onChange: e => setForm({ ...form, [key]: e.target.value }) })
            );
          })
        ),
        confirmDialog
      );
    }

    // ============================================================
    // Machines List
    // ============================================================
    function MachinesList({ clientId, clientName, onNavigate }) {
      const [machines, setMachines] = useState([]);
      const [modal, setModal] = useState(null);
      const [form, setForm] = useState({ name: '', type: '', serialNumber: '', brand: '', model: '' });
      const [confirm, confirmDialog] = useConfirm();

      const TYPES = ['Grue à tour GME','Grue à tour GMA','Grue mobile','Grue de chargement','Chariot élévateur','PEMP','Pont roulant','Portique','Hayon élévateur','Table élévatrice','Palan motorisé','Palan manuel','Pont élévateur véhicule','Plate-forme suspendue','Plate-forme sur mât','Accessoire de levage','Engin terrassement','Treuil','Autre'];

      const load = () => api.get(`/api/clients/${clientId}/machines`).then(setMachines).catch(console.error);
      useEffect(() => { load(); }, [clientId]);

      const openAdd = () => { setForm({ name: '', type: TYPES[0], serialNumber: '', brand: '', model: '' }); setModal('add'); };
      const openEdit = (m) => { setForm({ ...m }); setModal(m); };

      const handleSave = async () => {
        if (!form.name || !form.type) return;
        if (modal === 'add') await api.post(`/api/clients/${clientId}/machines`, form);
        else await api.put(`/api/machines/${modal.id}`, form);
        setModal(null); load();
      };

      const handleDelete = async (id) => {
        if (await confirm('Supprimer cette machine et tous ses contrôles ?')) {
          await api.del(`/api/machines/${id}`); load();
        }
      };

      const handleNewControle = async (machineId) => {
        const today = new Date().toISOString().split('T')[0];
        const data = await api.post('/api/controles', { machineId, status: 'en_cours', controlDate: today });
        onNavigate('controle-form', { id: data.id });
      };

      return React.createElement('div', null,
        React.createElement('button', { className: 'btn btn-outline', onClick: () => onNavigate('clients'), style: { marginBottom: 16 } },
          React.createElement('i', { className: 'fas fa-arrow-left' }), ' Retour aux clients'
        ),
        React.createElement('div', { className: 'card' },
          React.createElement('div', { className: 'card-header' },
            React.createElement('h3', null, `Machines de ${clientName}`),
            React.createElement('button', { className: 'btn btn-primary', onClick: openAdd },
              React.createElement('i', { className: 'fas fa-plus' }), ' Ajouter une machine'
            )
          ),
          machines.length === 0 ? React.createElement('div', { className: 'empty-state' }, React.createElement('i', { className: 'fas fa-cogs' }), React.createElement('p', null, 'Aucune machine')) :
          React.createElement('div', { style: { overflowX: 'auto' } },
            React.createElement('table', null,
              React.createElement('thead', null,
                React.createElement('tr', null,
                  React.createElement('th', null, 'Nom'),
                  React.createElement('th', null, 'Type'),
                  React.createElement('th', null, 'N° Série'),
                  React.createElement('th', null, 'Marque'),
                  React.createElement('th', null, 'Actions')
                )
              ),
              React.createElement('tbody', null,
                machines.map(m => React.createElement('tr', { key: m.id },
                  React.createElement('td', null, React.createElement('strong', null, m.name)),
                  React.createElement('td', null, m.type),
                  React.createElement('td', null, m.serialNumber || '-'),
                  React.createElement('td', null, m.brand || '-'),
                  React.createElement('td', null,
                    React.createElement('div', { className: 'btn-group' },
                      React.createElement('button', { className: 'btn btn-sm btn-primary', onClick: () => handleNewControle(m.id) },
                        React.createElement('i', { className: 'fas fa-clipboard-check' }), ' Contrôler'
                      ),
                      React.createElement('button', { className: 'btn btn-sm btn-outline', onClick: () => onNavigate('historique', { machineId: m.id, machineName: m.name }) },
                        React.createElement('i', { className: 'fas fa-history' })
                      ),
                      React.createElement('button', { className: 'btn btn-sm btn-outline', onClick: () => openEdit(m) },
                        React.createElement('i', { className: 'fas fa-edit' })
                      ),
                      React.createElement('button', { className: 'btn-icon', onClick: () => handleDelete(m.id) },
                        React.createElement('i', { className: 'fas fa-trash', style: { color: 'var(--danger)' } })
                      )
                    )
                  )
                ))
              )
            )
          )
        ),
        // Machine form modal
        React.createElement(Modal, {
          open: !!modal, onClose: () => setModal(null), title: modal === 'add' ? 'Nouvelle machine' : 'Modifier la machine',
          footer: React.createElement(React.Fragment, null,
            React.createElement('button', { className: 'btn btn-outline', onClick: () => setModal(null) }, 'Annuler'),
            React.createElement('button', { className: 'btn btn-primary', onClick: handleSave }, 'Enregistrer')
          )
        },
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', null, 'Nom *'),
            React.createElement('input', { className: 'form-input', value: form.name || '', onChange: e => setForm({ ...form, name: e.target.value }) })
          ),
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', null, 'Type *'),
            React.createElement('select', { className: 'form-input', value: form.type || '', onChange: e => setForm({ ...form, type: e.target.value }) },
              TYPES.map(t => React.createElement('option', { key: t, value: t }, t))
            )
          ),
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', null, 'N° Série'),
            React.createElement('input', { className: 'form-input', value: form.serialNumber || '', onChange: e => setForm({ ...form, serialNumber: e.target.value }) })
          ),
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', null, 'Marque'),
            React.createElement('input', { className: 'form-input', value: form.brand || '', onChange: e => setForm({ ...form, brand: e.target.value }) })
          ),
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', null, 'Modèle'),
            React.createElement('input', { className: 'form-input', value: form.model || '', onChange: e => setForm({ ...form, model: e.target.value }) })
          )
        ),
        confirmDialog
      );
    }

    // ============================================================
    // Control History
    // ============================================================
    function HistoriquePage({ machineId, machineName, onNavigate }) {
      const [controles, setControles] = useState([]);
      const load = () => api.get(`/api/machines/${machineId}/controles`).then(setControles).catch(console.error);
      useEffect(() => { load(); }, [machineId]);
      const [confirm, confirmDialog] = useConfirm();

      const handleDelete = async (id) => {
        if (await confirm('Supprimer ce contrôle ?')) { await api.del(`/api/controles/${id}`); load(); }
      };

      const handlePlan = async () => {
        const data = await api.post('/api/controles', { machineId: parseInt(machineId), status: 'a_faire', plannedDate: new Date(Date.now() + 7 * 86400000).toISOString().split('T')[0] });
        load();
      };

      return React.createElement('div', null,
        React.createElement('button', { className: 'btn btn-outline', onClick: () => onNavigate('back'), style: { marginBottom: 16 } },
          React.createElement('i', { className: 'fas fa-arrow-left' }), ' Retour'
        ),
        React.createElement('div', { className: 'card' },
          React.createElement('div', { className: 'card-header' },
            React.createElement('h3', null, `Historique - ${machineName}`),
            React.createElement('button', { className: 'btn btn-primary', onClick: handlePlan },
              React.createElement('i', { className: 'fas fa-calendar-plus' }), ' Planifier un contrôle'
            )
          ),
          controles.length === 0 ? React.createElement('div', { className: 'empty-state' }, React.createElement('i', { className: 'fas fa-history' }), React.createElement('p', null, 'Aucun contrôle')) :
          React.createElement('div', { style: { overflowX: 'auto' } },
            React.createElement('table', null,
              React.createElement('thead', null,
                React.createElement('tr', null,
                  React.createElement('th', null, 'Statut'),
                  React.createElement('th', null, 'Type'),
                  React.createElement('th', null, 'Date'),
                  React.createElement('th', null, 'Conclusion'),
                  React.createElement('th', null, 'Actions')
                )
              ),
              React.createElement('tbody', null,
                controles.map(c => React.createElement('tr', { key: c.id },
                  React.createElement('td', null, React.createElement(StatusBadge, { status: c.status })),
                  React.createElement('td', null, c.type),
                  React.createElement('td', null, c.controlDate || c.plannedDate || '-'),
                  React.createElement('td', null, c.conclusion ? (c.conclusion.length > 40 ? c.conclusion.slice(0, 40) + '...' : c.conclusion) : '-'),
                  React.createElement('td', null,
                    React.createElement('div', { className: 'btn-group' },
                      c.status === 'termine' && React.createElement('button', { className: 'btn btn-sm btn-success', onClick: () => onNavigate('controle-view', { id: c.id }) },
                        React.createElement('i', { className: 'fas fa-file-pdf' })
                      ),
                      (c.status === 'en_cours' || c.status === 'a_faire') && React.createElement('button', { className: 'btn btn-sm btn-primary', onClick: () => onNavigate('controle-form', { id: c.id }) },
                        React.createElement('i', { className: 'fas fa-edit' })
                      ),
                      React.createElement('button', { className: 'btn-icon', onClick: () => handleDelete(c.id) },
                        React.createElement('i', { className: 'fas fa-trash', style: { color: 'var(--danger)' } })
                      )
                    )
                  )
                ))
              )
            )
          )
        ),
        confirmDialog
      );
    }

    // ============================================================
    // Control Form (based on INRS ED 6339 document)
    // ============================================================
    function ControleForm({ controleId, onNavigate }) {
      const [controle, setControle] = useState(null);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        api.get(`/api/controles/${controleId}`).then(c => { setControle(c); setLoading(false); }).catch(console.error);
      }, [controleId]);

      const update = (field, value) => setControle(prev => ({ ...prev, [field]: value }));

      const handleSave = async (finish = false) => {
        setSaving(true);
        const data = { ...controle };
        if (finish) {
          data.status = 'termine';
          data.sentToClient = 1;
          const exp = new Date();
          exp.setFullYear(exp.getFullYear() + 1);
          data.expirationDate = exp.toISOString().split('T')[0];
        } else {
          data.status = 'en_cours';
          if (!data.controlDate) data.controlDate = new Date().toISOString().split('T')[0];
        }
        try {
          await api.put(`/api/controles/${controleId}`, data);
          if (finish) onNavigate('controles', { status: 'termine' });
          else alert('Contrôle sauvegardé');
        } catch(e) { alert(e.message); }
        setSaving(false);
      };

      if (loading) return React.createElement('div', { style: { padding: 40, textAlign: 'center' } }, React.createElement('div', { className: 'spinner' }));

      const RadioField = ({ label, field }) => React.createElement('div', { className: 'form-group' },
        React.createElement('label', null, label),
        React.createElement('div', { className: 'radio-group' },
          ['Conforme', 'Non conforme', 'Sans objet', 'Non vérifié'].map(v =>
            React.createElement('label', { key: v, className: 'radio-option' },
              React.createElement('input', { type: 'radio', name: field, value: v, checked: controle[field] === v, onChange: () => update(field, v) }), v
            )
          )
        )
      );

      return React.createElement('div', null,
        React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20, flexWrap: 'wrap', gap: 12 } },
          React.createElement('button', { className: 'btn btn-outline', onClick: () => onNavigate('back') },
            React.createElement('i', { className: 'fas fa-arrow-left' }), ' Retour'
          ),
          React.createElement('div', { className: 'btn-group' },
            React.createElement('button', { className: 'btn btn-outline', onClick: () => handleSave(false), disabled: saving },
              saving ? React.createElement('div', { className: 'spinner' }) : React.createElement(React.Fragment, null, React.createElement('i', { className: 'fas fa-save' }), ' Sauvegarder')
            ),
            React.createElement('button', { className: 'btn btn-success', onClick: () => handleSave(true), disabled: saving },
              React.createElement('i', { className: 'fas fa-check' }), ' Terminer le contrôle'
            )
          )
        ),

        // Machine Info
        React.createElement('div', { className: 'control-section', style: { marginBottom: 20 } },
          React.createElement('h3', null, React.createElement('i', { className: 'fas fa-info-circle', style: { marginRight: 8 } }), 'Informations'),
          React.createElement('div', { className: 'control-grid' },
            React.createElement('div', null, React.createElement('strong', null, 'Machine: '), controle.machineName),
            React.createElement('div', null, React.createElement('strong', null, 'Type: '), controle.machineType),
            React.createElement('div', null, React.createElement('strong', null, 'N° Série: '), controle.serialNumber || '-'),
            React.createElement('div', null, React.createElement('strong', null, 'Client: '), controle.clientName),
            React.createElement('div', { className: 'form-group', style: { marginBottom: 0 } },
              React.createElement('label', null, 'Date du contrôle'),
              React.createElement('input', { type: 'date', className: 'form-input', value: controle.controlDate || '', onChange: e => update('controlDate', e.target.value) })
            )
          )
        ),

        // Examen d'adéquation (Art. 5-I)
        React.createElement('div', { className: 'control-section', style: { marginBottom: 20 } },
          React.createElement('h3', null, React.createElement('i', { className: 'fas fa-check-double', style: { marginRight: 8 } }), "Examen d'adéquation (Art. 5-I)"),
          React.createElement(RadioField, { label: "L'appareil est approprié aux travaux prévus", field: 'adequation_conformite' }),
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', null, 'Observations'),
            React.createElement('textarea', { className: 'form-input', value: controle.adequation_observations || '', onChange: e => update('adequation_observations', e.target.value), placeholder: 'Observations éventuelles...' })
          )
        ),

        // Examen de montage (Art. 5-II)
        React.createElement('div', { className: 'control-section', style: { marginBottom: 20 } },
          React.createElement('h3', null, React.createElement('i', { className: 'fas fa-tools', style: { marginRight: 8 } }), "Examen de montage et d'installation (Art. 5-II)"),
          React.createElement(RadioField, { label: "Montage conforme à la notice du fabricant", field: 'montage_conformite' }),
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', null, 'Observations'),
            React.createElement('textarea', { className: 'form-input', value: controle.montage_observations || '', onChange: e => update('montage_observations', e.target.value) })
          )
        ),

        // État de conservation (Art. 9)
        React.createElement('div', { className: 'control-section', style: { marginBottom: 20 } },
          React.createElement('h3', null, React.createElement('i', { className: 'fas fa-search', style: { marginRight: 8 } }), "Examen de l'état de conservation (Art. 9)"),
          React.createElement(RadioField, { label: 'a) Dispositifs de calage, amarrage et freinage', field: 'conservation_calage' }),
          React.createElement(RadioField, { label: 'b) Freins ou dispositifs équivalents', field: 'conservation_freins' }),
          React.createElement(RadioField, { label: 'c) Dispositifs contrôlant la descente des charges', field: 'conservation_descente' }),
          React.createElement(RadioField, { label: 'd) Poulies de mouflage, poulies à empreintes', field: 'conservation_poulies' }),
          React.createElement(RadioField, { label: 'e) Limiteurs de charge et de moment de renversement', field: 'conservation_limiteurs' }),
          React.createElement(RadioField, { label: 'f) Dispositifs limiteurs de mouvements', field: 'conservation_dispositifs' }),
          React.createElement(RadioField, { label: 'g) Crochets et appareils de préhension', field: 'conservation_crochets' }),
          React.createElement(RadioField, { label: 'h) Câbles et chaînes de charge', field: 'conservation_cables' }),
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', null, 'Observations'),
            React.createElement('textarea', { className: 'form-input', value: controle.conservation_observations || '', onChange: e => update('conservation_observations', e.target.value) })
          )
        ),

        // Essais de fonctionnement (Art. 6)
        React.createElement('div', { className: 'control-section', style: { marginBottom: 20 } },
          React.createElement('h3', null, React.createElement('i', { className: 'fas fa-play-circle', style: { marginRight: 8 } }), "Essais de fonctionnement (Art. 6)"),
          React.createElement(RadioField, { label: 'b) Efficacité des freins', field: 'essais_freins' }),
          React.createElement(RadioField, { label: 'b) Dispositifs contrôlant la descente', field: 'essais_descente' }),
          React.createElement(RadioField, { label: 'b) Limiteurs de course', field: 'essais_limiteurs_course' }),
          React.createElement(RadioField, { label: 'c) Limiteurs de charge et moment de renversement', field: 'essais_limiteurs_charge' }),
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', null, 'Observations'),
            React.createElement('textarea', { className: 'form-input', value: controle.essais_observations || '', onChange: e => update('essais_observations', e.target.value) })
          )
        ),

        // Épreuves (Art. 10 & 11)
        React.createElement('div', { className: 'control-section', style: { marginBottom: 20 } },
          React.createElement('h3', null, React.createElement('i', { className: 'fas fa-weight-hanging', style: { marginRight: 8 } }), "Épreuves (Art. 10 & 11)"),
          React.createElement('div', { className: 'control-grid' },
            React.createElement(RadioField, { label: 'Épreuve statique réalisée', field: 'epreuve_statique' }),
            React.createElement('div', { className: 'form-group' },
              React.createElement('label', null, 'Charge statique (kg)'),
              React.createElement('input', { className: 'form-input', value: controle.epreuve_statique_charge || '', onChange: e => update('epreuve_statique_charge', e.target.value) })
            ),
            React.createElement('div', { className: 'form-group' },
              React.createElement('label', null, 'Durée (min)'),
              React.createElement('input', { className: 'form-input', value: controle.epreuve_statique_duree || '', onChange: e => update('epreuve_statique_duree', e.target.value) })
            ),
            React.createElement(RadioField, { label: 'Résultat épreuve statique', field: 'epreuve_statique_resultat' }),
          ),
          React.createElement('hr', { style: { margin: '16px 0', border: 'none', borderTop: '1px solid var(--border)' } }),
          React.createElement('div', { className: 'control-grid' },
            React.createElement(RadioField, { label: 'Épreuve dynamique réalisée', field: 'epreuve_dynamique' }),
            React.createElement('div', { className: 'form-group' },
              React.createElement('label', null, 'Charge dynamique (kg)'),
              React.createElement('input', { className: 'form-input', value: controle.epreuve_dynamique_charge || '', onChange: e => update('epreuve_dynamique_charge', e.target.value) })
            ),
            React.createElement(RadioField, { label: 'Résultat épreuve dynamique', field: 'epreuve_dynamique_resultat' }),
          )
        ),

        // Conclusion
        React.createElement('div', { className: 'control-section', style: { marginBottom: 20 } },
          React.createElement('h3', null, React.createElement('i', { className: 'fas fa-gavel', style: { marginRight: 8 } }), 'Conclusion'),
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', null, 'Avis général'),
            React.createElement('select', { className: 'form-input', value: controle.conclusion || '', onChange: e => update('conclusion', e.target.value) },
              React.createElement('option', { value: '' }, '-- Sélectionner --'),
              React.createElement('option', { value: 'Appareil conforme - RAS' }, 'Appareil conforme - RAS'),
              React.createElement('option', { value: 'Conforme avec observations mineures' }, 'Conforme avec observations mineures'),
              React.createElement('option', { value: 'Non conforme - observations majeures' }, 'Non conforme - observations majeures'),
              React.createElement('option', { value: 'Appareil à mettre hors service' }, 'Appareil à mettre hors service')
            )
          ),
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', null, 'Observations complémentaires'),
            React.createElement('textarea', { className: 'form-input', rows: 4, value: controle.conclusion_observations || '', onChange: e => update('conclusion_observations', e.target.value) })
          )
        ),

        // Save buttons
        React.createElement('div', { style: { display: 'flex', justifyContent: 'flex-end', gap: 12, marginTop: 20, marginBottom: 40 } },
          React.createElement('button', { className: 'btn btn-outline', onClick: () => handleSave(false), disabled: saving, style: { padding: '12px 24px' } },
            React.createElement('i', { className: 'fas fa-save' }), ' Sauvegarder le brouillon'
          ),
          React.createElement('button', { className: 'btn btn-success', onClick: () => handleSave(true), disabled: saving, style: { padding: '12px 24px' } },
            React.createElement('i', { className: 'fas fa-check-circle' }), ' Terminer et envoyer'
          )
        )
      );
    }

    // ============================================================
    // Controle View (Report)
    // ============================================================
    function ControleView({ controleId, onNavigate }) {
      const [c, setC] = useState(null);
      const { user } = useContext(AuthContext);
      useEffect(() => { api.get(`/api/controles/${controleId}`).then(setC).catch(console.error); }, [controleId]);

      if (!c) return React.createElement('div', { style: { padding: 40, textAlign: 'center' } }, React.createElement('div', { className: 'spinner' }));

      const Row = ({ label, value }) => React.createElement('tr', null,
        React.createElement('td', { style: { fontWeight: 500, width: '40%' } }, label),
        React.createElement('td', null, value || '-')
      );

      return React.createElement('div', null,
        React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 20, flexWrap: 'wrap', gap: 12 } },
          React.createElement('button', { className: 'btn btn-outline', onClick: () => onNavigate('back') },
            React.createElement('i', { className: 'fas fa-arrow-left' }), ' Retour'
          ),
          React.createElement('button', { className: 'btn btn-primary', onClick: () => window.print() },
            React.createElement('i', { className: 'fas fa-print' }), ' Imprimer / PDF'
          )
        ),
        React.createElement('div', { className: 'card', style: { padding: 32 } },
          React.createElement('div', { style: { textAlign: 'center', marginBottom: 24 } },
            user.companyLogo && React.createElement('img', { src: user.companyLogo, style: { maxHeight: 60, marginBottom: 12 } }),
            React.createElement('h2', { style: { fontSize: 22 } }, 'Rapport de Vérification Générale Périodique'),
            React.createElement('p', { style: { color: 'var(--text-light)' } }, `Rapport N° VGP-${c.id.toString().padStart(4, '0')}`)
          ),

          React.createElement('table', { style: { marginBottom: 24 } },
            React.createElement('tbody', null,
              React.createElement(Row, { label: 'Machine', value: `${c.machineName} (${c.machineType})` }),
              React.createElement(Row, { label: 'N° Série', value: c.serialNumber }),
              React.createElement(Row, { label: 'Marque / Modèle', value: `${c.brand || ''} ${c.model || ''}` }),
              React.createElement(Row, { label: 'Client', value: `${c.clientName} - ${c.clientFirstName} ${c.clientLastName}` }),
              React.createElement(Row, { label: 'Adresse', value: c.clientAddress }),
              React.createElement(Row, { label: 'Date du contrôle', value: c.controlDate }),
              React.createElement(Row, { label: 'Prochaine échéance', value: c.expirationDate }),
              React.createElement(Row, { label: "Adéquation", value: c.adequation_conformite }),
              React.createElement(Row, { label: "Montage", value: c.montage_conformite }),
              React.createElement(Row, { label: "Freins", value: c.conservation_freins }),
              React.createElement(Row, { label: "Câbles/Chaînes", value: c.conservation_cables }),
              React.createElement(Row, { label: "Essais freins", value: c.essais_freins }),
              React.createElement(Row, { label: "Limiteurs charge", value: c.essais_limiteurs_charge }),
              React.createElement(Row, { label: "Épreuve statique", value: c.epreuve_statique_resultat }),
              React.createElement(Row, { label: "Épreuve dynamique", value: c.epreuve_dynamique_resultat })
            )
          ),

          React.createElement('div', { style: { padding: 16, borderRadius: 8, background: c.conclusion?.includes('conforme') ? '#dcfce7' : '#fee2e2', marginBottom: 24 } },
            React.createElement('strong', null, 'Conclusion: '), c.conclusion || 'Non renseignée'
          ),
          c.conclusion_observations && React.createElement('p', { style: { marginBottom: 24 } }, React.createElement('strong', null, 'Observations: '), c.conclusion_observations),

          React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', marginTop: 32, borderTop: '1px solid var(--border)', paddingTop: 16 } },
            React.createElement('div', null,
              React.createElement('p', null, React.createElement('strong', null, 'Contrôleur: '), `${user.firstName} ${user.lastName}`),
              React.createElement('p', { style: { color: 'var(--text-light)', fontSize: 13 } }, `Date: ${c.controlDate}`)
            ),
            user.signature && React.createElement('div', null,
              React.createElement('p', { style: { fontSize: 13, color: 'var(--text-light)', marginBottom: 4 } }, 'Signature:'),
              React.createElement('img', { src: user.signature, style: { maxHeight: 60 } })
            )
          )
        )
      );
    }

    // ============================================================
    // Profile Page
    // ============================================================
    function ProfilePage() {
      const { user, setUser } = useContext(AuthContext);
      const [form, setForm] = useState({ firstName: user.firstName, lastName: user.lastName });
      const [msg, setMsg] = useState('');
      const canvasRef = useRef(null);
      const [drawing, setDrawing] = useState(false);

      const handleSave = async () => {
        await api.put('/api/profile', form);
        setUser({ ...user, ...form });
        setMsg('Profil mis à jour !');
        setTimeout(() => setMsg(''), 3000);
      };

      // Signature pad
      const startDraw = (e) => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        setDrawing(true);
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
        const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
        ctx.beginPath();
        ctx.moveTo(x, y);
      };
      const draw = (e) => {
        if (!drawing) return;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
        const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#1e293b';
        ctx.lineWidth = 2;
        ctx.stroke();
      };
      const stopDraw = () => setDrawing(false);
      const clearSig = () => {
        const canvas = canvasRef.current;
        if (canvas) canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
      };
      const saveSig = async () => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const dataUrl = canvas.toDataURL('image/png');
        await api.post('/api/profile/signature', { signature: dataUrl });
        setUser({ ...user, signature: dataUrl });
        setMsg('Signature enregistrée !');
        setTimeout(() => setMsg(''), 3000);
      };

      return React.createElement('div', { style: { maxWidth: 600 } },
        msg && React.createElement('div', { className: 'success-msg', style: { marginBottom: 16 } }, msg),
        React.createElement('div', { className: 'card', style: { padding: 24, marginBottom: 24 } },
          React.createElement('h3', { style: { marginBottom: 16 } }, 'Informations personnelles'),
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', null, 'Prénom'),
            React.createElement('input', { className: 'form-input', value: form.firstName, onChange: e => setForm({ ...form, firstName: e.target.value }) })
          ),
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', null, 'Nom'),
            React.createElement('input', { className: 'form-input', value: form.lastName, onChange: e => setForm({ ...form, lastName: e.target.value }) })
          ),
          React.createElement('div', { className: 'form-group' },
            React.createElement('label', null, 'Email'),
            React.createElement('input', { className: 'form-input', value: user.email, disabled: true })
          ),
          React.createElement('button', { className: 'btn btn-primary', onClick: handleSave }, React.createElement('i', { className: 'fas fa-save' }), ' Enregistrer')
        ),

        React.createElement('div', { className: 'card', style: { padding: 24 } },
          React.createElement('h3', { style: { marginBottom: 16 } }, 'Signature électronique'),
          React.createElement('p', { style: { fontSize: 13, color: 'var(--text-light)', marginBottom: 12 } }, 'Dessinez votre signature ci-dessous. Elle apparaîtra dans les rapports.'),
          React.createElement('canvas', {
            ref: canvasRef, width: 500, height: 150, className: 'signature-pad',
            onMouseDown: startDraw, onMouseMove: draw, onMouseUp: stopDraw, onMouseLeave: stopDraw,
            onTouchStart: startDraw, onTouchMove: draw, onTouchEnd: stopDraw
          }),
          React.createElement('div', { style: { display: 'flex', gap: 8, marginTop: 12 } },
            React.createElement('button', { className: 'btn btn-outline', onClick: clearSig }, 'Effacer'),
            React.createElement('button', { className: 'btn btn-primary', onClick: saveSig }, React.createElement('i', { className: 'fas fa-save' }), ' Sauvegarder la signature')
          ),
          user.signature && React.createElement('div', { style: { marginTop: 16 } },
            React.createElement('p', { style: { fontSize: 13, color: 'var(--text-light)', marginBottom: 4 } }, 'Signature actuelle:'),
            React.createElement('img', { src: user.signature, style: { maxHeight: 60, border: '1px solid var(--border)', borderRadius: 4, padding: 4 } })
          )
        )
      );
    }

    // ============================================================
    // Admin Page
    // ============================================================
    function AdminPage() {
      const [users, setUsers] = useState([]);
      const [email, setEmail] = useState('');
      const [msg, setMsg] = useState('');
      const [confirm, confirmDialog] = useConfirm();

      const load = () => api.get('/api/admin/users').then(setUsers).catch(console.error);
      useEffect(() => { load(); }, []);

      const handleAdd = async () => {
        if (!email) return;
        try {
          const r = await api.post('/api/admin/users', { email });
          setMsg(r.message);
          setEmail('');
          load();
        } catch(e) { setMsg(e.message); }
      };

      const handleDelete = async (id) => {
        if (await confirm('Supprimer cet utilisateur ?')) {
          await api.del(`/api/admin/users/${id}`); load();
        }
      };

      return React.createElement('div', null,
        React.createElement('div', { className: 'card', style: { padding: 24, marginBottom: 24 } },
          React.createElement('h3', { style: { marginBottom: 16 } }, 'Inviter un utilisateur'),
          msg && React.createElement('div', { className: 'success-msg', style: { marginBottom: 12 } }, msg),
          React.createElement('div', { style: { display: 'flex', gap: 8 } },
            React.createElement('input', { className: 'form-input', placeholder: 'Email du nouvel utilisateur', value: email, onChange: e => setEmail(e.target.value), style: { flex: 1 } }),
            React.createElement('button', { className: 'btn btn-primary', onClick: handleAdd },
              React.createElement('i', { className: 'fas fa-paper-plane' }), ' Inviter'
            )
          )
        ),
        React.createElement('div', { className: 'card' },
          React.createElement('div', { className: 'card-header' },
            React.createElement('h3', null, 'Utilisateurs'),
          ),
          React.createElement('table', null,
            React.createElement('thead', null,
              React.createElement('tr', null,
                React.createElement('th', null, 'Email'),
                React.createElement('th', null, 'Nom'),
                React.createElement('th', null, 'Rôle'),
                React.createElement('th', null, 'Actions')
              )
            ),
            React.createElement('tbody', null,
              users.map(u => React.createElement('tr', { key: u.id },
                React.createElement('td', null, u.email),
                React.createElement('td', null, `${u.firstName || ''} ${u.lastName || ''}`),
                React.createElement('td', null, React.createElement('span', { className: u.role === 'admin' ? 'badge badge-primary' : 'badge badge-info' }, u.role)),
                React.createElement('td', null,
                  React.createElement('button', { className: 'btn-icon', onClick: () => handleDelete(u.id) },
                    React.createElement('i', { className: 'fas fa-trash', style: { color: 'var(--danger)' } })
                  )
                )
              ))
            )
          )
        ),
        confirmDialog
      );
    }

    // ============================================================
    // Main App
    // ============================================================
    function App() {
      const { user, logout } = useContext(AuthContext);
      const [page, setPage] = useState('dashboard');
      const [pageParams, setPageParams] = useState({});
      const [sidebarOpen, setSidebarOpen] = useState(false);
      const [history, setHistory] = useState([]);

      if (!user) return React.createElement(LoginPage);

      const navigate = (p, params = {}) => {
        if (p === 'back') {
          const prev = history[history.length - 1];
          if (prev) { setHistory(h => h.slice(0, -1)); setPage(prev.page); setPageParams(prev.params); }
          else { setPage('dashboard'); setPageParams({}); }
        } else {
          setHistory(h => [...h, { page, params: pageParams }]);
          setPage(p);
          setPageParams(params);
        }
        setSidebarOpen(false);
      };

      const pageTitle = {
        dashboard: 'Tableau de bord',
        controles: `Contrôles - ${STATUS_MAP[pageParams.status]?.label || ''}`,
        clients: 'Clients',
        machines: `Machines - ${pageParams.clientName || ''}`,
        historique: `Historique - ${pageParams.machineName || ''}`,
        'controle-form': 'Formulaire de contrôle',
        'controle-view': 'Rapport de contrôle',
        profile: 'Mon profil',
        admin: 'Administration',
      };

      const renderPage = () => {
        switch(page) {
          case 'dashboard': return React.createElement(Dashboard, { onNavigate: navigate });
          case 'controles': return React.createElement(ControlesList, { status: pageParams.status, onNavigate: navigate });
          case 'clients': return React.createElement(ClientsList, { onNavigate: navigate });
          case 'machines': return React.createElement(MachinesList, { clientId: pageParams.clientId, clientName: pageParams.clientName, onNavigate: navigate });
          case 'historique': return React.createElement(HistoriquePage, { machineId: pageParams.machineId, machineName: pageParams.machineName, onNavigate: navigate });
          case 'controle-form': return React.createElement(ControleForm, { controleId: pageParams.id, onNavigate: navigate });
          case 'controle-view': return React.createElement(ControleView, { controleId: pageParams.id, onNavigate: navigate });
          case 'profile': return React.createElement(ProfilePage);
          case 'admin': return React.createElement(AdminPage);
          default: return React.createElement(Dashboard, { onNavigate: navigate });
        }
      };

      return React.createElement('div', { className: 'app-layout' },
        // Sidebar
        React.createElement('div', { className: `sidebar ${sidebarOpen ? 'open' : ''}` },
          React.createElement('div', { className: 'sidebar-logo' },
            React.createElement('div', { className: 'icon' }, React.createElement('i', { className: 'fas fa-shield-alt' })),
            React.createElement('div', null,
              React.createElement('h1', null, 'Protec Contrôle'),
              React.createElement('div', { style: { fontSize: 11, opacity: .6 } }, 'Gestion VGP')
            )
          ),
          React.createElement('nav', { className: 'sidebar-nav' },
            React.createElement('div', { className: 'nav-section' }, 'Navigation'),
            React.createElement('a', { className: `nav-item ${page === 'dashboard' ? 'active' : ''}`, onClick: () => navigate('dashboard') },
              React.createElement('i', { className: 'fas fa-tachometer-alt' }), 'Tableau de bord'
            ),
            React.createElement('a', { className: `nav-item ${page === 'clients' ? 'active' : ''}`, onClick: () => navigate('clients') },
              React.createElement('i', { className: 'fas fa-building' }), 'Mes clients'
            ),
            React.createElement('div', { className: 'nav-section' }, 'Compte'),
            React.createElement('a', { className: `nav-item ${page === 'profile' ? 'active' : ''}`, onClick: () => navigate('profile') },
              React.createElement('i', { className: 'fas fa-user' }), 'Mon profil'
            ),
            user.role === 'admin' && React.createElement('a', { className: `nav-item ${page === 'admin' ? 'active' : ''}`, onClick: () => navigate('admin') },
              React.createElement('i', { className: 'fas fa-cog' }), 'Administration'
            ),
            React.createElement('a', { className: 'nav-item', onClick: logout },
              React.createElement('i', { className: 'fas fa-sign-out-alt' }), 'Se déconnecter'
            )
          )
        ),
        // Main
        React.createElement('div', { className: 'main-content' },
          React.createElement('div', { className: 'topbar' },
            React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
              React.createElement('button', { className: 'menu-toggle', onClick: () => setSidebarOpen(!sidebarOpen) },
                React.createElement('i', { className: 'fas fa-bars' })
              ),
              React.createElement('h2', null, pageTitle[page] || 'Protec Contrôle')
            ),
            React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
              React.createElement('span', { style: { fontSize: 13, color: 'var(--text-light)' } }, `${user.firstName} ${user.lastName}`),
              React.createElement('span', { className: user.role === 'admin' ? 'badge badge-primary' : 'badge badge-info' }, user.role)
            )
          ),
          React.createElement('div', { className: 'page-content' }, renderPage())
        ),
        // Mobile overlay
        sidebarOpen && React.createElement('div', {
          style: { position: 'fixed', inset: 0, background: 'rgba(0,0,0,.3)', zIndex: 99 },
          onClick: () => setSidebarOpen(false)
        })
      );
    }

    // ============================================================
    // Render
    // ============================================================
    ReactDOM.createRoot(document.getElementById('root')).render(
      React.createElement(AuthProvider, null, React.createElement(App))
    );
  </script>
</body>
</html>
